#!/usr/bin/env python3

import sys, os, argparse
import numpy as np
sys.path.insert(0, os.environ["ATTRACTTOOLS"])
usage = "USAGE: python deredundant-npy.py structures.npy cutoff [--fit] [--center]\n"
from npy import npy2to3, npy3to2

############
parser =argparse.ArgumentParser(description=__doc__,
                        formatter_class=argparse.RawDescriptionHelpFormatter)
parser.add_argument('npyfile', help="np array")
parser.add_argument('cutoff', help="cutoff",type=float)
parser.add_argument('--outp', help="np array deredundanted")
parser.add_argument("--fit",help="fit on 1st structure", action="store_true")
parser.add_argument("--center",help="center at origine", action="store_true")
args = parser.parse_args()
############
npy = np.load(args.npyfile)
npy = npy3to2(npy)

name = args.npyfile.split(".npy")[0]
if not args.outp:
    outp = name + '-dr' + str(args.cutoff) + '.npy'
else:
    outp = args.outp


if args.fit:
    print >> sys.stderr, "fitting"
    from rmsdlib import multifit
    rotation, translation, RMSD = multifit(npy, npy[0])
    rot = np.transpose(rotation, axes=(0,2,1))
    COM = npy.sum(axis=1)/npy.shape[1]
    translated = npy - COM[:,None,:]
    print >> sys.stderr, rot.shape
    print >> sys.stderr, translated.shape
    npy = np.einsum('...ij,...jk->...ik',translated,rot)
    npy = npy[ [i for i in range(len(RMSD)) if RMSD[i] > args.cutoff] ]

    if not args.center:
        COM1 = npy[0].sum(axis=0)
        npy = npy + COM1

from cluster import cluster
c = cluster(npy, args.cutoff, 1000)
centers = np.array([ c[k][0] for k in c.keys()])
npclust = npy[centers]
clustlist = open(name+"-clust"+str(args.cutoff), "w")
for k in centers:
    print >> clustlist, "%i "%k
np.save(args.outp,npclust)
clustlist.close()
